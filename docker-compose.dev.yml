# Development override - extends docker-compose.yml
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  postgres:
    container_name: saga-dev-postgres
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data

  booking-api:
    image: booking-api:dev
    container_name: booking-api-dev
    build:
      dockerfile: ./src/Services/Booking.API/Dockerfile.dev
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ENABLE_WATCH=false
    ports:
      - "5011:5011" # Debug port
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
    volumes:
      - ./src/Services/Booking.API:/src/Services/Booking.API
      - ./src/Common:/src/Common

  flight-api:
    image: flight-api:dev
    container_name: flight-api-dev
    build:
      dockerfile: ./src/Services/Flight.API/Dockerfile.dev
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ENABLE_WATCH=false
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      booking-api:
        condition: service_started
    volumes:
      - ./src/Services/Flight.API:/src/Services/Flight.API
      - ./src/Common:/src/Common

  hotel-api:
    image: hotel-api:dev
    container_name: hotel-api-dev
    build:
      dockerfile: ./src/Services/Hotel.API/Dockerfile.dev
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ENABLE_WATCH=false
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      flight-api:
        condition: service_started
    volumes:
      - ./src/Services/Hotel.API:/src/Services/Hotel.API
      - ./src/Common:/src/Common

  car-api:
    image: car-api:dev
    container_name: car-api-dev
    build:
      dockerfile: ./src/Services/Car.API/Dockerfile.dev
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ENABLE_WATCH=false
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
      hotel-api:
        condition: service_started
    volumes:
      - ./src/Services/Car.API:/src/Services/Car.API
      - ./src/Common:/src/Common

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.111.0
    container_name: saga-dev-otel-collector
    command: [ "--config=/etc/otelcol-contrib/config.yaml" ]
    volumes:
      - ./observability/otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml:ro
    ports:
      - "4317:4317"
      - "4318:4318"
    depends_on:
      - tempo
    networks:
      - saga-network

  prometheus:
    image: prom/prometheus:v2.54.1
    container_name: saga-dev-prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--web.enable-remote-write-receiver"
      - "--enable-feature=exemplar-storage"
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./observability/prometheus-recording-rules.yml:/etc/prometheus/prometheus-recording-rules.yml:ro
      - ./observability/prometheus-alerts.yml:/etc/prometheus/prometheus-alerts.yml:ro
    ports:
      - "9090:9090"
    networks:
      - saga-network

  tempo:
    image: grafana/tempo:2.6.1
    container_name: saga-dev-tempo
    command: [ "-config.file=/etc/tempo.yaml" ]
    volumes:
      - ./observability/tempo.yaml:/etc/tempo.yaml:ro
    ports:
      - "3200:3200"
    depends_on:
      - prometheus
    networks:
      - saga-network

  grafana:
    image: grafana/grafana:11.2.0
    container_name: saga-dev-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_dev_data:/var/lib/grafana
      - ./observability/grafana-datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml:ro
      - ./observability/grafana-dashboards.yaml:/etc/grafana/provisioning/dashboards/dashboards.yaml:ro
      - ./observability/dashboards:/etc/grafana/provisioning/dashboards/json:ro
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - tempo
    networks:
      - saga-network

volumes:
  postgres_dev_data:
  grafana_dev_data:
