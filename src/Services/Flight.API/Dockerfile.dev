# Development Dockerfile with hot reload support
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS development
WORKDIR /src

COPY ["NuGet.Config", "./"]

# Install vsdbg for remote debugging
RUN apt update && apt install unzip && \
    curl -sSL https://aka.ms/getvsdbgsh | /bin/sh /dev/stdin -v latest -l /vsdbg

# Copy project files
COPY ["src/Services/Flight.API/Flight.API.csproj", "Services/Flight.API/"]
COPY ["src/Common/Domain/Shared.Domain.csproj", "Common/Domain/"]
COPY ["src/Common/Shared/Shared.Infrastructure.csproj", "Common/Shared/"]

# Restore dependencies
ENV NUGET_FALLBACK_PACKAGES=

RUN dotnet restore "Services/Flight.API/Flight.API.csproj"

# Copy all source code
COPY ["src/Services/Flight.API/", "Services/Flight.API/"]
COPY ["src/Common/", "Common/"]

# Set working directory to the API project
WORKDIR /src/Services/Flight.API

# Expose ports (app + debugger)
# EXPOSE 5002
EXPOSE 5012

# Enable polling file watcher for Docker
ENV DOTNET_USE_POLLING_FILE_WATCHER=true

# Create startup script that restores packages after volume mount and conditionally enables watch mode
RUN echo '#!/bin/bash' > /entrypoint.sh && \
    echo 'echo "Restoring NuGet packages..."' >> /entrypoint.sh && \
    echo 'dotnet restore' >> /entrypoint.sh && \
    echo 'if [ "$ENABLE_WATCH" = "true" ]; then' >> /entrypoint.sh && \
    echo '  exec dotnet watch run --no-restore' >> /entrypoint.sh && \
    echo 'else' >> /entrypoint.sh && \
    echo '  exec dotnet run --no-restore' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

# Run with conditional behavior - controlled by ENABLE_WATCH env var
ENTRYPOINT ["/entrypoint.sh"]
